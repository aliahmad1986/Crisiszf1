<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Centers</h5>
                    <h2 class="card-text" id="stat-total"><?php echo $this->stats['total'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Active</h5>
                    <h2 class="card-text" id="stat-active"><?php echo $this->stats['active'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Inactive</h5>
                    <h2 class="card-text" id="stat-inactive"><?php echo $this->stats['inactive'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Types</h5>
                    <h2 class="card-text" id="stat-types"><?php echo $this->stats['types_count'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Oldest</h5>
                    <h6 class="card-text" id="stat-oldest"><?php echo $this->stats['oldest_center'] ? date('Y-m-d', strtotime($this->stats['oldest_center'])) : 'N/A'; ?></h6>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">Newest</h5>
                    <h6 class="card-text" id="stat-newest"><?php echo $this->stats['newest_center'] ? date('Y-m-d', strtotime($this->stats['newest_center'])) : 'N/A'; ?></h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-chart-bar mr-2"></i>Centers by Type</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="centersByTypeChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-info-circle mr-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCenterModal">
                            <i class="fa fa-plus mr-2"></i> Add New Center
                        </button>
                        <button type="button" class="btn btn-success" id="exportBtn">
                            <i class="fa fa-file-export mr-2"></i> Export to Excel
                        </button>
                        <button type="button" class="btn btn-warning" id="refreshStatsBtn">
                            <i class="fa fa-sync mr-2"></i> Refresh Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fa fa-filter mr-2"></i>Filters & Bulk Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filterType">Center Type</label>
                        <select class="form-control" id="filterType">
                            <option value="">All Types</option>
                            <?php foreach ($this->centerTypes as $type): ?>
                            <option value="<?php echo $type['CenterTypeID']; ?>">
                                <?php echo htmlspecialchars($type['CenterTypeName'], ENT_QUOTES, 'UTF-8'); ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filterStatus">Status</label>
                        <select class="form-control" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="bulkAction">Bulk Action</label>
                        <select class="form-control" id="bulkAction">
                            <option value="">Select Action</option>
                            <option value="activate">Activate Selected</option>
                            <option value="deactivate">Deactivate Selected</option>
                            <option value="export_selected">Export Selected</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-info btn-block" id="applyBulkAction">
                            <i class="fa fa-play"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Select All Centers on This Page
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Centers Table Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fa fa-building mr-2"></i>Centers Management (SQL Server)</h3>
                    <div class="card-tools">
                        <span class="badge badge-info" id="serverInfo">
                            <i class="fa fa-database mr-1"></i> SQL Server
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="centersTable" class="table table-bordered table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th width="20">
                                        <input type="checkbox" id="masterCheckbox">
                                    </th>
                                    <th>ID</th>
                                    <th>Center Name</th>
                                    <th>Type</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX (server-side processing) -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fa fa-file-export mr-2"></i>Export Centers</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Select export options:</p>
                <div class="form-group">
                    <label>Format:</label>
                    <select class="form-control" id="exportFormat">
                        <option value="csv">CSV (Excel)</option>
                        <option value="excel">Excel (XLSX)</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Apply Current Filters:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="applyFilters" checked>
                        <label class="form-check-label" for="applyFilters">
                            Export filtered results only
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExport">
                    <i class="fa fa-download mr-1"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable with server-side processing
    var table = $('#centersTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "<?php echo $this->url(array('module' => 'center', 'controller' => 'center', 'action' => 'index'), 'default', true); ?>",
            "type": "POST",
            "data": function(d) {
                // Add custom filters
                d.filter_type = $('#filterType').val();
                d.filter_status = $('#filterStatus').val();
            },
            "error": function(xhr, error, thrown) {
                console.error('DataTable error:', error);
                showAlert('error', 'Error loading centers data from SQL Server');
            }
        },
        "columns": [
            {
                "data": null,
                "orderable": false,
                "className": "text-center",
                "render": function(data, type, row) {
                    return '<input type="checkbox" class="center-checkbox" value="' + row.CenterID + '">';
                }
            },
            {"data": "CenterID", "className": "text-center"},
            {"data": "CenterName"},
            {"data": "CenterTypeName", "className": "text-center"},
            {"data": "Address"},
            {"data": "Phone1", "className": "text-center"},
            {"data": "Website", "className": "text-center"},
            {"data": "IsActive", "className": "text-center"},
            {"data": "CreatedAt", "className": "text-center"},
            {"data": "Actions", "className": "text-center", "orderable": false}
        ],
        "responsive": true,
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "order": [[1, 'desc']],
        "language": {
            "emptyTable": "No centers found in database",
            "info": "Showing _START_ to _END_ of _TOTAL_ centers",
            "infoEmpty": "Showing 0 to 0 of 0 centers",
            "infoFiltered": "(filtered from _MAX_ total centers)",
            "lengthMenu": "Show _MENU_ centers",
            "loadingRecords": "Loading from SQL Server...",
            "processing": '<i class="fa fa-database fa-spin"></i> Processing...',
            "search": "Search in SQL Server:",
            "zeroRecords": "No matching centers found"
        },
        "drawCallback": function(settings) {
            // Update master checkbox
            var allChecked = $('.center-checkbox:checked').length === $('.center-checkbox').length;
            $('#masterCheckbox').prop('checked', allChecked);
            
            // Update select all checkbox
            $('#selectAll').prop('checked', false);
        }
    });

    // Initialize chart
    var centersByTypeChart = null;
    function initChart() {
        var ctx = document.getElementById('centersByTypeChart').getContext('2d');
        
        var data = {
            labels: [
                <?php foreach ($this->centersByType as $type): ?>
                "<?php echo addslashes($type['CenterTypeName']); ?>",
                <?php endforeach; ?>
            ],
            datasets: [{
                label: 'Total Centers',
                data: [
                    <?php foreach ($this->centersByType as $type): ?>
                    <?php echo $type['center_count'] ?? 0; ?>,
                    <?php endforeach; ?>
                ],
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
                ]
            }]
        };
        
        centersByTypeChart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    initChart();

    // Apply filters
    $('#filterType, #filterStatus').on('change', function() {
        table.draw();
    });

    // Master checkbox
    $('#masterCheckbox').on('change', function() {
        var isChecked = $(this).prop('checked');
        $('.center-checkbox').prop('checked', isChecked);
    });

    // Select all pages
    $('#selectAll').on('change', function() {
        if ($(this).prop('checked')) {
            // Select all centers (requires custom implementation)
            selectAllCenters();
        } else {
            $('.center-checkbox').prop('checked', false);
        }
    });

    // Apply bulk action
    $('#applyBulkAction').on('click', function() {
        var action = $('#bulkAction').val();
        var selectedIds = getSelectedCenterIds();
        
        if (selectedIds.length === 0) {
            showAlert('warning', 'Please select at least one center');
            return;
        }
        
        switch(action) {
            case 'activate':
            case 'deactivate':
                var status = (action === 'activate') ? 1 : 0;
                bulkUpdateStatus(selectedIds, status);
                break;
            case 'export_selected':
                exportSelected(selectedIds);
                break;
            default:
                showAlert('warning', 'Please select an action');
        }
    });

    // Export button
    $('#exportBtn').on('click', function() {
        $('#exportModal').modal('show');
    });

    // Confirm export
    $('#confirmExport').on('click', function() {
        var format = $('#exportFormat').val();
        var applyFilters = $('#applyFilters').prop('checked');
        
        var url = '<?php echo $this->url(array('module' => 'center', 'controller' => 'center', 'action' => 'export'), 'default', true); ?>';
        
        // Add filters to URL
        if (applyFilters) {
            var type = $('#filterType').val();
            var status = $('#filterStatus').val();
            
            if (type) url += '?type=' + type;
            if (status) url += (type ? '&' : '?') + 'status=' + status;
        }
        
        // For CSV, just redirect
        if (format === 'csv') {
            window.location.href = url;
        } else {
            showAlert('info', format.toUpperCase() + ' export is not yet implemented');
        }
        
        $('#exportModal').modal('hide');
    });

    // Refresh statistics
    $('#refreshStatsBtn').on('click', function() {
        refreshStatistics();
    });

    // Functions
    function getSelectedCenterIds() {
        var ids = [];
        $('.center-checkbox:checked').each(function() {
            ids.push($(this).val());
        });
        return ids;
    }

    function bulkUpdateStatus(centerIds, status) {
        $.ajax({
            url: '<?php echo $this->url(array('module' => 'center', 'controller' => 'center', 'action' => 'bulk-update'), 'default', true); ?>',
            type: 'POST',
            data: {
                centerIds: centerIds,
                status: status
            },
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    showAlert('success', result.message);
                    table.draw(); // Refresh table
                    refreshStatistics(); // Refresh stats
                } else {
                    showAlert('error', result.message);
                }
            },
            error: function() {
                showAlert('error', 'Network error. Please try again.');
            }
        });
    }

    function exportSelected(centerIds) {
        // Create a form and submit it
        var form = $('<form>', {
            'method': 'post',
            'action': '<?php echo $this->url(array('module' => 'center', 'controller' => 'center', 'action' => 'export'), 'default', true); ?>',
            'target': '_blank'
        });
        
        $.each(centerIds, function(index, id) {
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'centerIds[]',
                'value': id
            }));
        });
        
        $('body').append(form);
        form.submit();
        form.remove();
    }

    function selectAllCenters() {
        // This would require a custom endpoint to get all IDs matching current filters
        showAlert('info', 'Select all feature requires server-side implementation');
    }

    function refreshStatistics() {
        $.ajax({
            url: '<?php echo $this->url(array('module' => 'center', 'controller' => 'center', 'action' => 'statistics'), 'default', true); ?>',
            type: 'GET',
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    // Update statistics cards
                    $('#stat-total').text(result.stats.total);
                    $('#stat-active').text(result.stats.active);
                    $('#stat-inactive').text(result.stats.inactive);
                    $('#stat-types').text(result.stats.types_count);
                    
                    if (result.stats.oldest_center) {
                        $('#stat-oldest').text(result.stats.oldest_center.split(' ')[0]);
                    }
                    if (result.stats.newest_center) {
                        $('#stat-newest').text(result.stats.newest_center.split(' ')[0]);
                    }
                    
                    // Update chart
                    updateChart(result.byType);
                    
                    showAlert('success', 'Statistics refreshed successfully');
                } else {
                    showAlert('error', result.message);
                }
            },
            error: function() {
                showAlert('error', 'Error refreshing statistics');
            }
        });
    }

    function updateChart(byTypeData) {
        if (centersByTypeChart) {
            centersByTypeChart.data.labels = byTypeData.map(function(item) {
                return item.CenterTypeName;
            });
            centersByTypeChart.data.datasets[0].data = byTypeData.map(function(item) {
                return item.center_count;
            });
            centersByTypeChart.update();
        }
    }

    function showAlert(type, message) {
        var alertClass = type === 'success' ? 'alert-success' : 
                         type === 'error' ? 'alert-danger' : 
                         type === 'warning' ? 'alert-warning' : 'alert-info';
        var icon = type === 'success' ? 'fa-check-circle' : 
                   type === 'error' ? 'fa-exclamation-circle' : 
                   type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        
        var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            '<i class="fa ' + icon + ' mr-2"></i>' + message +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>' +
            '</div>';
        
        // Remove existing alerts
        $('.alert-dismissible').alert('close');
        
        // Add new alert
        $('.container-fluid').prepend(alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(function() {
            $('.alert-dismissible').alert('close');
        }, 5000);
    }

    // ... Rest of the JavaScript (form handling, etc.) remains the same
});
</script>
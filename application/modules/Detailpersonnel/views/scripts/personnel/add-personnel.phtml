<form id="addPersonnelForm" method="post" action="<?php echo $this->url(array('module' => 'Detailpersonnel', 'controller' => 'personnel', 'action' => 'add-personnel'), null, true); ?>">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="PersonnelID">Personnel *</label>
                <select class="form-control select2" id="PersonnelID" name="PersonnelID" required style="width: 100%;">
                    <option value="">Select Personnel</option>
                    <?php foreach ($this->personnelList as $personnel): ?>
                    <option value="<?php echo $personnel['PersonnelID']; ?>">
                        <?php echo htmlspecialchars($personnel['FullName'], ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <small class="form-text text-muted">Select the personnel to assign to a department</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="DepartmentID">Department *</label>
                <select class="form-control select2" id="DepartmentID" name="DepartmentID" required style="width: 100%;">
    <option value="">Select Department</option>
    <?php foreach ($this->departments as $department): ?>
    <option value="<?php echo $department['DepartmentID']; ?>">
        <?php echo htmlspecialchars($department['DepartmentName'], ENT_QUOTES, 'UTF-8'); ?>
        <?php if (!empty($department['DepartmentCode'])): ?>
            (<?php echo htmlspecialchars($department['DepartmentCode'], ENT_QUOTES, 'UTF-8'); ?>)
        <?php endif; ?>
    </option>
    <?php endforeach; ?>
</select>
                <small class="form-text text-muted">Select the department for this assignment</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="PositionID">Position *</label>
                <select class="form-control select2" id="PositionID" name="PositionID" required style="width: 100%;">
                    <option value="">Select Position</option>
                    <?php foreach ($this->positions as $position): ?>
                    <option value="<?php echo $position['BaseInfoID']; ?>">
                        <?php echo htmlspecialchars($position['Name'], ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <small class="form-text text-muted">Select the position in this department</small>
            </div>
        </div>
        <div class="col-md-3" style="direction:ltr">
            <div class="form-group">
                <label for="FromDate">From Date *</label>
                <div class="input-group date">
                    <input type="text" class="form-control datepicker" id="FromDate" name="FromDate" required 
                           placeholder="YYYY-MM-DD" autocomplete="off">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                </div>
                <small class="form-text text-muted">Start date of assignment</small>
            </div>
        </div>
        <div class="col-md-3" style="direction:ltr">
            <div class="form-group">
                <label for="ToDate">To Date</label>
                <div class="input-group date">
                    <input type="text" class="form-control datepicker" id="ToDate" name="ToDate" 
                           placeholder="YYYY-MM-DD" autocomplete="off">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                </div>
                <small class="form-text text-muted">Leave empty for current assignment</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="Description">Description</label>
                <textarea class="form-control" id="Description" name="Description" rows="3" maxlength="50" 
                          placeholder="Brief description of this assignment"></textarea>
                <small class="form-text text-muted">Max 50 characters. Optional description for this assignment.</small>
                <div class="char-count">
                    <span id="charCount">0</span>/50 characters
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>Assignment Type</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveYes" value="1" checked>
                    <label class="form-check-label" for="ActiveYes">
                        Active Assignment
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveNo" value="0">
                    <label class="form-check-label" for="ActiveNo">
                        Inactive/Historical Assignment
                    </label>
                </div>
                <small class="form-text text-muted">Active assignments appear in current personnel lists</small>
            </div>
        </div>
 
    </div>
    
    <hr>
    
    <div class="alert alert-info">
        <i class="fa fa-info-circle"></i> 
        <strong>Note:</strong> The system will check for overlapping date ranges in the same department. 
        If this personnel already has an assignment in the selected department during the specified dates, 
        the assignment will be rejected.
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fa fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> Save Assignment
        </button>
    </div>
</form>

<style>
.char-count {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: right;
    margin-top: 5px;
}
.input-group .input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
}
.select2-container--default .select2-selection--single {
    height: calc(2.25rem + 2px);
    padding: .375rem .75rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 1.5;
}
</style>

<script>
$(document).ready(function() {
    // Initialize Select2 for dropdowns
    $('.select2').select2({
        theme: 'bootstrap4',
        placeholder: 'Select an option',
        allowClear: true
    });

    // Initialize datepicker with Persian date support if needed
       $(".datepicker").persianDatepicker({format: 'YYYY-MM-DD',  calendar:{
        persian: {
            leapYearMode: 'astronomical'
        }
    }});

 

    // Character counter for description
    $('#Description').on('input', function() {
        var length = $(this).val().length;
        $('#charCount').text(length);
        
        if (length > 50) {
            $('#charCount').css('color', 'red');
            $(this).val($(this).val().substring(0, 50));
            $('#charCount').text(50);
        } else {
            $('#charCount').css('color', '#6c757d');
        }
    });

    // Form validation and submission
    $('#addPersonnelForm').on('submit', function(e) {
        e.preventDefault();
        
        // Clear previous error states
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Basic validation
        var isValid = true;
        var errorMessages = [];
        
        if (!$('#PersonnelID').val()) {
            $('#PersonnelID').addClass('is-invalid');
            $('#PersonnelID').after('<div class="invalid-feedback">Please select a personnel</div>');
            isValid = false;
        }
        
        if (!$('#DepartmentID').val()) {
            $('#DepartmentID').addClass('is-invalid');
            $('#DepartmentID').after('<div class="invalid-feedback">Please select a department</div>');
            isValid = false;
        }
        
        if (!$('#PositionID').val()) {
            $('#PositionID').addClass('is-invalid');
            $('#PositionID').after('<div class="invalid-feedback">Please select a position</div>');
            isValid = false;
        }
        
        if (!$('#FromDate').val()) {
            $('#FromDate').addClass('is-invalid');
            $('#FromDate').after('<div class="invalid-feedback">Please enter a from date</div>');
            isValid = false;
        }
        
        // Validate date range if both dates are provided
        var fromDate = $('#FromDate').val();
        var toDate = $('#ToDate').val();
        
        if (fromDate && toDate && toDate < fromDate) {
            $('#ToDate').addClass('is-invalid');
            $('#ToDate').after('<div class="invalid-feedback">To Date cannot be earlier than From Date</div>');
            isValid = false;
        }
        
        if (!isValid) {
            return false;
        }
        
        // Show loading state
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Saving...');
        
        // Submit form via AJAX
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                try {
                    var result = JSON.parse(response);
                    if (result.success) {
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: result.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Close modal and reload table
                        setTimeout(function() {
                            $('#addPersonnelModal').modal('hide');
                            $('#personnelDetailsTable').DataTable().ajax.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: result.message
                        });
                        
                        // Re-enable submit button
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'An error occurred while processing the response'
                    });
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while submitting the form: ' + error
                });
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Reset form when modal is closed
    $('#addPersonnelModal').on('hidden.bs.modal', function() {
        $('#addPersonnelForm')[0].reset();
        $('.select2').val(null).trigger('change');
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        $('#charCount').text('0').css('color', '#6c757d');
    });

    // Auto-focus first field when modal opens
    $('#addPersonnelModal').on('shown.bs.modal', function() {
        $('#PersonnelID').select2('open');
    });
});
</script>
<?php 
$personnelDetail = $this->personnelDetail;
?>
<form id="editPersonnelForm" method="post" action="<?php echo $this->url(array('module' => 'Detailpersonnel', 'controller' => 'personnel', 'action' => 'edit-personnel'), null, true); ?>/id/<?php echo $personnelDetail['DetailID']; ?>">
    <input type="hidden" name="DetailID" value="<?php echo $personnelDetail['DetailID']; ?>">
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="PersonnelID">Personnel *</label>
                <select class="form-control select2" id="PersonnelID" name="PersonnelID" required style="width: 100%;" disabled>
                    <option value="">Select Personnel</option>
                    <?php foreach ($this->personnelList as $personnel): ?>
                    <option value="<?php echo $personnel['PersonnelID']; ?>" 
                        <?php echo ($personnel['PersonnelID'] == $personnelDetail['PersonnelID']) ? 'selected' : ''; ?>>
                        <?php echo htmlspecialchars($personnel['FullName'], ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <input type="hidden" name="PersonnelID" value="<?php echo $personnelDetail['PersonnelID']; ?>">
                <small class="form-text text-muted">Personnel cannot be changed after assignment creation</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="DepartmentID">Department *</label>
               <select class="form-control select2" id="DepartmentID" name="DepartmentID" required style="width: 100%;">
    <option value="">Select Department</option>
    <?php foreach ($this->departments as $department): ?>
    <option value="<?php echo $department['DepartmentID']; ?>">
        <?php echo htmlspecialchars($department['DepartmentName'], ENT_QUOTES, 'UTF-8'); ?>
        <?php if (!empty($department['DepartmentCode'])): ?>
            (<?php echo htmlspecialchars($department['DepartmentCode'], ENT_QUOTES, 'UTF-8'); ?>)
        <?php endif; ?>
    </option>
    <?php endforeach; ?>
</select>
                <small class="form-text text-muted">Select the department for this assignment</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="PositionID">Position *</label>
                <select class="form-control select2" id="PositionID" name="PositionID" required style="width: 100%;">
                    <option value="">Select Position</option>
                    <?php foreach ($this->positions as $position): ?>
                    <option value="<?php echo $position['BaseInfoID']; ?>" 
                        <?php echo ($position['BaseInfoID'] == $personnelDetail['PositionID']) ? 'selected' : ''; ?>>
                        <?php echo htmlspecialchars($position['Name'], ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <small class="form-text text-muted">Select the position in this department</small>
            </div>
        </div>
        <div class="col-md-3" style="direction:ltr">
            <div class="form-group">
                <label for="FromDate">From Date *</label>
                <div class="input-group date">
                    <input type="text" class="form-control datepicker" id="FromDate" name="FromDate" required 
                           value="<?php echo htmlspecialchars($personnelDetail['FromDate'], ENT_QUOTES, 'UTF-8'); ?>"
                           placeholder="YYYY-MM-DD" autocomplete="off">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                </div>
                <small class="form-text text-muted">Start date of assignment</small>
            </div>
        </div>
        <div class="col-md-3" style="direction:ltr">
            <div class="form-group">
                <label for="ToDate">To Date</label>
                <div class="input-group date">
                    <input type="text" class="form-control datepicker" id="ToDate" name="ToDate" 
                           value="<?php echo !empty($personnelDetail['ToDate']) ? htmlspecialchars($personnelDetail['ToDate'], ENT_QUOTES, 'UTF-8') : ''; ?>"
                           placeholder="YYYY-MM-DD" autocomplete="off">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                </div>
                <small class="form-text text-muted">Leave empty for current assignment</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="Description">Description</label>
                <textarea class="form-control" id="Description" name="Description" rows="3" maxlength="50" 
                          placeholder="Brief description of this assignment"><?php echo !empty($personnelDetail['Description']) ? htmlspecialchars($personnelDetail['Description'], ENT_QUOTES, 'UTF-8') : ''; ?></textarea>
                <small class="form-text text-muted">Max 50 characters. Optional description for this assignment.</small>
                <div class="char-count">
                    <span id="charCount"><?php echo strlen($personnelDetail['Description'] ?? ''); ?></span>/50 characters
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>Assignment Status</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveYes" value="1" 
                        <?php echo ($personnelDetail['IsActive'] == 1) ? 'checked' : ''; ?>>
                    <label class="form-check-label" for="ActiveYes">
                        Active Assignment
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveNo" value="0"
                        <?php echo ($personnelDetail['IsActive'] == 0) ? 'checked' : ''; ?>>
                    <label class="form-check-label" for="ActiveNo">
                        Inactive/Historical Assignment
                    </label>
                </div>
                <small class="form-text text-muted">Active assignments appear in current personnel lists</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <div class="row">
                    <div class="col-12">
                        <label>Assignment Information</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-2">
                            <small class="text-muted">
                                <i class="fa fa-calendar"></i> Created: <?php echo date('Y-m-d H:i', strtotime($personnelDetail['CreatedAt'])); ?>
                            </small>
                        </div>
                    </div>
                </div>
                <?php if (!empty($personnelDetail['UpdatedAt'])): ?>
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-2">
                            <small class="text-muted">
                                <i class="fa fa-edit"></i> Last Updated: <?php echo date('Y-m-d H:i', strtotime($personnelDetail['UpdatedAt'])); ?>
                            </small>
                        </div>
                    </div>
                </div>
                <?php endif; ?>
                
                <!-- Additional options -->
                <div class="custom-control custom-checkbox mt-3">
                    <input type="checkbox" class="custom-control-input" id="EndAssignment" name="EndAssignment" value="1">
                    <label class="custom-control-label" for="EndAssignment">
                        <span class="text-danger">End this assignment</span>
                    </label>
                    <small class="form-text text-muted">Check to set To Date as today and mark as inactive</small>
                </div>
            </div>
        </div>
    </div>
    
    <hr>
    
    <div class="alert alert-warning">
        <i class="fa fa-exclamation-triangle"></i> 
        <strong>Important:</strong> 
        <ul class="mb-0 pl-3">
            <li>Changing dates may affect overlapping assignments validation</li>
            <li>If you set a past To Date, the assignment will be marked as historical</li>
            <li>Personnel field cannot be changed to maintain assignment history integrity</li>
        </ul>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" id="deleteAssignmentBtn">
            <i class="fa fa-trash"></i> Delete
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> Update Assignment
        </button>
    </div>
</form>

<style>
.char-count {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: right;
    margin-top: 5px;
}
.input-group .input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
}
.select2-container--default .select2-selection--single {
    height: calc(2.25rem + 2px);
    padding: .375rem .75rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 1.5;
}
</style>

<script>
$(document).ready(function() {
    var detailId = <?php echo $personnelDetail['DetailID']; ?>;
    var originalPersonnelId = <?php echo $personnelDetail['PersonnelID']; ?>;
    var originalFromDate = '<?php echo $personnelDetail['FromDate']; ?>';
    var originalToDate = '<?php echo $personnelDetail['ToDate'] ?? ''; ?>';
    var originalDeptId = <?php echo $personnelDetail['DepartmentID']; ?>;
    
    // Initialize Select2 for dropdowns
    $('.select2').select2({
        theme: 'bootstrap4',
        placeholder: 'Select an option',
        allowClear: true
    });

    // Initialize datepicker
        $(".datepicker").persianDatepicker({format: 'YYYY-MM-DD',  calendar:{
        persian: {
            leapYearMode: 'astronomical'
        }
    }});



    // Character counter for description
    $('#Description').on('input', function() {
        var length = $(this).val().length;
        $('#charCount').text(length);
        
        if (length > 50) {
            $('#charCount').css('color', 'red');
            $(this).val($(this).val().substring(0, 50));
            $('#charCount').text(50);
        } else {
            $('#charCount').css('color', '#6c757d');
        }
    });

    // End Assignment checkbox logic
    $('#EndAssignment').on('change', function() {
        if ($(this).is(':checked')) {
            // Set To Date as today
            var today = new Date();
            var todayStr = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
            $('#ToDate').val(todayStr);
            $('#ToDate').prop('readonly', true);
            
            // Mark as inactive
            $('#ActiveNo').prop('checked', true);
            
            // Show confirmation
            Swal.fire({
                icon: 'warning',
                title: 'End Assignment',
                text: 'This assignment will be ended today and marked as inactive.',
                showCancelButton: true,
                confirmButtonText: 'Continue',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (!result.isConfirmed) {
                    $(this).prop('checked', false);
                    $('#ToDate').val(originalToDate);
                    $('#ToDate').prop('readonly', false);
                    $('#ActiveYes').prop('checked', true);
                }
            });
        } else {
            $('#ToDate').val(originalToDate);
            $('#ToDate').prop('readonly', false);
        }
    });

    // Form validation and submission
    $('#editPersonnelForm').on('submit', function(e) {
        e.preventDefault();
        
        // Clear previous error states
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Basic validation
        var isValid = true;
        
        if (!$('#DepartmentID').val()) {
            $('#DepartmentID').addClass('is-invalid');
            $('#DepartmentID').after('<div class="invalid-feedback">Please select a department</div>');
            isValid = false;
        }
        
        if (!$('#PositionID').val()) {
            $('#PositionID').addClass('is-invalid');
            $('#PositionID').after('<div class="invalid-feedback">Please select a position</div>');
            isValid = false;
        }
        
        if (!$('#FromDate').val()) {
            $('#FromDate').addClass('is-invalid');
            $('#FromDate').after('<div class="invalid-feedback">Please enter a from date</div>');
            isValid = false;
        }
        
        // Validate date range if both dates are provided
        var fromDate = $('#FromDate').val();
        var toDate = $('#ToDate').val();
        
        if (fromDate && toDate && toDate < fromDate) {
            $('#ToDate').addClass('is-invalid');
            $('#ToDate').after('<div class="invalid-feedback">To Date cannot be earlier than From Date</div>');
            isValid = false;
        }
        
        // Check if dates have changed significantly
        if (fromDate !== originalFromDate || toDate !== originalToDate) {
            Swal.fire({
                icon: 'warning',
                title: 'Date Change Detected',
                text: 'You have changed the assignment dates. This may affect overlapping assignments validation.',
                showCancelButton: true,
                confirmButtonText: 'Continue',
                cancelButtonText: 'Review Changes'
            }).then((result) => {
                if (!result.isConfirmed) {
                    isValid = false;
                    return false;
                }
            });
        }
        
        if (!isValid) {
            return false;
        }
        
        // Show loading state
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Updating...');
        
        // Submit form via AJAX
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                try {
                    var result = JSON.parse(response);
                    if (result.success) {
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Updated!',
                            text: result.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Close modal and reload table
                        setTimeout(function() {
                            $('#editPersonnelModal').modal('hide');
                            $('#personnelDetailsTable').DataTable().ajax.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: result.message
                        });
                        
                        // Re-enable submit button
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'An error occurred while processing the response'
                    });
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while updating: ' + error
                });
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Delete assignment button
    $('#deleteAssignmentBtn').on('click', function() {
        Swal.fire({
            icon: 'warning',
            title: 'Delete Assignment',
            text: 'Are you sure you want to delete this assignment? This action cannot be undone.',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Deleting...');
                
                $.ajax({
                    url: "<?php echo $this->url(array('module' => 'Detailpersonnel', 'controller' => 'personnel', 'action' => 'delete'), null, true); ?>",
                    type: "POST",
                    data: {id: detailId},
                    success: function(response) {
                        var result = JSON.parse(response);
                        if (result.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: result.message,
                                timer: 2000,
                                showConfirmButton: false
                            });
                            
                            setTimeout(function() {
                                $('#editPersonnelModal').modal('hide');
                                $('#personnelDetailsTable').DataTable().ajax.reload();
                            }, 1500);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: result.message
                            });
                            $('#deleteAssignmentBtn').prop('disabled', false).html('<i class="fa fa-trash"></i> Delete');
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'An error occurred while deleting'
                        });
                        $('#deleteAssignmentBtn').prop('disabled', false).html('<i class="fa fa-trash"></i> Delete');
                    }
                });
            }
        });
    });

    // Auto-focus first editable field when modal opens
    $('#editPersonnelModal').on('shown.bs.modal', function() {
        $('#DepartmentID').select2('open');
    });
});
</script>
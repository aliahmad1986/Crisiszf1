<?php $center = $this->center; ?>
<form id="editCenterForm" action="<?php echo $this->url(array('module' => 'Center', 'controller' => 'center', 'action' => 'edit-center', 'id' => $center['CenterID']), 'default', true); ?>">
    <input type="hidden" name="id" value="<?php echo $center['CenterID']; ?>">
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="CenterName">Center Name *</label>
                <input type="text" class="form-control" id="CenterName" name="CenterName" 
                       value="<?php echo $this->escape($center['CenterName']); ?>" required maxlength="200"
                       data-center-id="<?php echo $center['CenterID']; ?>">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="CenterTypeID">Center Type *</label>
                <select class="form-control" id="CenterTypeID" name="CenterTypeID" required>
                    <option value="">Select Center Type</option>
                    <?php foreach ($this->centerTypes as $type): ?>
                    <option value="<?php echo $type['CenterTypeID']; ?>" 
                        <?php echo $center['CenterTypeID'] == $type['CenterTypeID'] ? 'selected' : ''; ?>>
                        <?php echo htmlspecialchars($type['CenterTypeName'], ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label for="Address">Address</label>
        <textarea class="form-control" id="Address" name="Address" rows="3" maxlength="500"><?php echo $this->escape($center['Address']); ?></textarea>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Phone1">Primary Phone *</label>
                <input type="tel" class="form-control" id="Phone1" name="Phone1" 
                       value="<?php echo $this->escape($center['Phone1']); ?>"
                       maxlength="15" pattern="^[\d\s\-\+\(\)]{10,15}$"
                       title="Enter a valid phone number (10-15 digits with optional +, -, (, ), or spaces)"
                       required>
                <small class="form-text text-muted">
                    Format: +98 XXX XXX XXXX or 0XXX XXX XXXX
                </small>
                <div class="invalid-feedback" id="phone1-error">
                    Please enter a valid phone number (10-15 digits)
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Phone2">Secondary Phone</label>
                <input type="tel" class="form-control" id="Phone2" name="Phone2" 
                       value="<?php echo $this->escape($center['Phone2']); ?>"
                       maxlength="15" pattern="^[\d\s\-\+\(\)]{0,15}$"
                       title="Enter a valid phone number (10-15 digits with optional +, -, (, ), or spaces) or leave blank">
                <small class="form-text text-muted">
                    Optional - Same format as primary phone
                </small>
                <div class="invalid-feedback" id="phone2-error">
                    Please enter a valid phone number (10-15 digits)
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label for="Website">Website</label>
        <input type="url" class="form-control" id="Website" name="Website" 
               value="<?php echo $this->escape($center['Website']); ?>"
               maxlength="200" pattern="^(http|https)://.*"
               title="Enter a valid URL starting with http:// or https://">
        <small class="form-text text-muted">
            Format: https://example.com
        </small>
        <div class="invalid-feedback">
            Please enter a valid URL starting with http:// or https://
        </div>
    </div>
    
    <div class="form-group">
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="IsActive" name="IsActive" 
                   value="1" <?php echo $center['IsActive'] ? 'checked' : ''; ?>>
            <label class="custom-control-label" for="IsActive">Active Center</label>
        </div>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Update Center</button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Format phone numbers on load for display
    function formatPhoneForDisplay(phone) {
        if (!phone) return '';
        
        // Remove all non-digit characters
        var digits = phone.replace(/\D/g, '');
        
        // Format for display
        if (digits.length === 10 && digits.startsWith('9')) {
            // Mobile: 9123456789 -> 0912 345 6789
            return '0' + digits.substring(0, 3) + ' ' + digits.substring(3, 6) + ' ' + digits.substring(6);
        } else if (digits.length === 10 && digits.startsWith('2')) {
            // Landline: 2123456789 -> 021 2345 6789
            return '0' + digits.substring(0, 2) + ' ' + digits.substring(2, 6) + ' ' + digits.substring(6);
        } else if (digits.length === 11 && digits.startsWith('98')) {
            // International: 989123456789 -> +98 912 345 6789
            return '+98 ' + digits.substring(2, 5) + ' ' + digits.substring(5, 8) + ' ' + digits.substring(8);
        } else if (digits.length === 12 && digits.startsWith('98')) {
            // International landline: 982123456789 -> +98 21 2345 6789
            return '+98 ' + digits.substring(2, 4) + ' ' + digits.substring(4, 8) + ' ' + digits.substring(8);
        }
        
        return phone;
    }
    
    // Format existing phone numbers on page load
    var phone1 = $('#Phone1').val();
    if (phone1) {
        $('#Phone1').val(formatPhoneForDisplay(phone1));
    }
    
    var phone2 = $('#Phone2').val();
    if (phone2) {
        $('#Phone2').val(formatPhoneForDisplay(phone2));
    }
    
    // Phone number validation and formatting
    function formatPhoneNumber(phone) {
        // Remove all non-digit characters
        var digits = phone.replace(/\D/g, '');
        
        // Format for Iranian phone numbers
        if (digits.length === 10 && digits.startsWith('9')) {
            // Mobile: 9123456789 -> 0912 345 6789
            return '0' + digits.substring(0, 3) + ' ' + digits.substring(3, 6) + ' ' + digits.substring(6);
        } else if (digits.length === 10 && digits.startsWith('2')) {
            // Landline: 2123456789 -> 021 2345 6789
            return '0' + digits.substring(0, 2) + ' ' + digits.substring(2, 6) + ' ' + digits.substring(6);
        } else if (digits.length === 11 && digits.startsWith('98')) {
            // International: 989123456789 -> +98 912 345 6789
            return '+98 ' + digits.substring(2, 5) + ' ' + digits.substring(5, 8) + ' ' + digits.substring(8);
        } else if (digits.length === 12 && digits.startsWith('98')) {
            // International landline: 982123456789 -> +98 21 2345 6789
            return '+98 ' + digits.substring(2, 4) + ' ' + digits.substring(4, 8) + ' ' + digits.substring(8);
        }
        
        return phone;
    }
    
    // Validate phone number
    function validatePhoneNumber(phone) {
        // Remove all non-digit characters for validation
        var digits = phone.replace(/\D/g, '');
        
        // Check if empty (for optional Phone2)
        if (phone.trim() === '') {
            return { valid: true, message: '' };
        }
        
        // Check length
        if (digits.length < 10 || digits.length > 15) {
            return { 
                valid: false, 
                message: 'Phone number must be 10-15 digits' 
            };
        }
        
        // Iranian mobile: 0912XXXXXXX or 912XXXXXXX or +98912XXXXXXX
        if (digits.match(/^(0)?9\d{9}$/) || digits.match(/^(98)?9\d{9}$/)) {
            return { valid: true, message: 'Valid mobile number' };
        }
        
        // Iranian landline: 021XXXXXXX or 21XXXXXXX or +9821XXXXXXX
        if (digits.match(/^(0)?2\d{9}$/) || digits.match(/^(98)?2\d{9}$/)) {
            return { valid: true, message: 'Valid landline number' };
        }
        
        // International numbers (generic validation)
        if (digits.match(/^\d{10,15}$/)) {
            return { valid: true, message: 'Valid international number' };
        }
        
        return { 
            valid: false, 
            message: 'Invalid phone number format' 
        };
    }
    
    // Phone1 validation
    $('#Phone1').on('blur', function() {
        var phone = $(this).val().trim();
        var validation = validatePhoneNumber(phone);
        
        if (validation.valid && phone) {
            // Format the phone number
            var formatted = formatPhoneNumber(phone);
            if (formatted !== phone) {
                $(this).val(formatted);
            }
            $(this).removeClass('is-invalid').addClass('is-valid');
            $('#phone1-error').text('');
        } else if (!phone) {
            $(this).removeClass('is-valid is-invalid');
            $('#phone1-error').text('Phone number is required');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
            $('#phone1-error').text(validation.message);
        }
    });
    
    // Phone2 validation (optional)
    $('#Phone2').on('blur', function() {
        var phone = $(this).val().trim();
        
        if (phone === '') {
            $(this).removeClass('is-valid is-invalid');
            $('#phone2-error').text('');
            return;
        }
        
        var validation = validatePhoneNumber(phone);
        
        if (validation.valid) {
            // Format the phone number
            var formatted = formatPhoneNumber(phone);
            if (formatted !== phone) {
                $(this).val(formatted);
            }
            $(this).removeClass('is-invalid').addClass('is-valid');
            $('#phone2-error').text('');
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
            $('#phone2-error').text(validation.message);
        }
    });
    
    // Real-time validation as user types
    $('#Phone1, #Phone2').on('input', function() {
        var phone = $(this).val();
        var digits = phone.replace(/\D/g, '');
        
        // Auto-format as user types
        if (digits.length <= 15) {
            // Format for Iranian numbers
            if (digits.startsWith('9') && digits.length <= 10) {
                // Mobile: 9123456789
                if (digits.length <= 3) {
                    $(this).val(digits);
                } else if (digits.length <= 6) {
                    $(this).val(digits.substring(0, 3) + ' ' + digits.substring(3));
                } else {
                    $(this).val(digits.substring(0, 3) + ' ' + digits.substring(3, 6) + ' ' + digits.substring(6));
                }
            } else if (digits.startsWith('2') && digits.length <= 10) {
                // Landline: 2123456789
                if (digits.length <= 2) {
                    $(this).val(digits);
                } else if (digits.length <= 6) {
                    $(this).val(digits.substring(0, 2) + ' ' + digits.substring(2));
                } else {
                    $(this).val(digits.substring(0, 2) + ' ' + digits.substring(2, 6) + ' ' + digits.substring(6));
                }
            } else if (digits.startsWith('98') && digits.length <= 12) {
                // International: 989123456789
                if (digits.length <= 3) {
                    $(this).val('+' + digits);
                } else if (digits.length <= 6) {
                    $(this).val('+' + digits.substring(0, 3) + ' ' + digits.substring(3));
                } else if (digits.length <= 9) {
                    $(this).val('+' + digits.substring(0, 3) + ' ' + digits.substring(3, 6) + ' ' + digits.substring(6));
                } else {
                    $(this).val('+' + digits.substring(0, 3) + ' ' + digits.substring(3, 6) + ' ' + digits.substring(6, 9) + ' ' + digits.substring(9));
                }
            }
        }
    });
    
    // Form submission validation
    $('#editCenterForm').on('submit', function(e) {
        var isValid = true;
        
        // Validate Phone1
        var phone1 = $('#Phone1').val().trim();
        var phone1Validation = validatePhoneNumber(phone1);
        if (!phone1Validation.valid || !phone1) {
            $('#Phone1').addClass('is-invalid');
            $('#phone1-error').text(phone1 ? phone1Validation.message : 'Phone number is required');
            isValid = false;
        }
        
        // Validate Phone2 (optional)
        var phone2 = $('#Phone2').val().trim();
        if (phone2) {
            var phone2Validation = validatePhoneNumber(phone2);
            if (!phone2Validation.valid) {
                $('#Phone2').addClass('is-invalid');
                $('#phone2-error').text(phone2Validation.message);
                isValid = false;
            }
        }
        
        // Validate Website URL format
        var website = $('#Website').val().trim();
        if (website && !website.match(/^(http|https):\/\/.+/)) {
            $('#Website').addClass('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            showFormAlert('error', 'Please correct the errors in the form');
            return false;
        }
        
        // Clean phone numbers before submission (remove spaces, dashes, etc.)
        if (phone1) {
            $('#Phone1').val(phone1.replace(/[\s\-\(\)]/g, ''));
        }
        if (phone2) {
            $('#Phone2').val(phone2.replace(/[\s\-\(\)]/g, ''));
        }
        
        return true;
    });
    
    // Clear validation on focus
    $('#Phone1, #Phone2, #Website').on('focus', function() {
        $(this).removeClass('is-invalid');
    });
    
    // Helper function for form alerts
    function showFormAlert(type, message) {
        var alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show mt-3" role="alert">' +
            message +
            '<button type="button" class="close" data-dismiss="alert">' +
            '<span>&times;</span>' +
            '</button>' +
            '</div>';
        
        // Remove existing alerts
        $('.alert').remove();
        
        // Add new alert after the form
        $('#editCenterForm').prepend(alertHtml);
    }
});
</script>
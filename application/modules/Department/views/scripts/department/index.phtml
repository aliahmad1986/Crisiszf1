<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Departments</h5>
                    <h2 class="card-text"><?php echo $this->stats['total'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Active</h5>
                    <h2 class="card-text"><?php echo $this->stats['active'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Inactive</h5>
                    <h2 class="card-text"><?php echo $this->stats['inactive'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Centers</h5>
                    <h2 class="card-text"><?php echo $this->stats['centers_count'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Types</h5>
                    <h2 class="card-text"><?php echo $this->stats['types_count'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">Today</h5>
                    <h6 class="card-text"><?php echo date('Y-m-d'); ?></h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Departments by Center Statistics -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fa fa-chart-pie mr-2"></i>Departments by Center</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Center</th>
                            <th class="text-center">Total Departments</th>
                            <th class="text-center">Active Departments</th>
                            <th class="text-center">Inactive Departments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($this->byCenter as $center): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($center['CenterName'], ENT_QUOTES, 'UTF-8'); ?></td>
                            <td class="text-center"><?php echo $center['department_count']; ?></td>
                            <td class="text-center"><?php echo $center['active_departments']; ?></td>
                            <td class="text-center"><?php echo $center['department_count'] - $center['active_departments']; ?></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fa fa-filter mr-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="filterCenter">Center</label>
                        <select class="form-control" id="filterCenter">
                            <option value="">All Centers</option>
                            <?php foreach ($this->centers as $center): ?>
                            <option value="<?php echo $center['CenterID']; ?>">
                                <?php echo htmlspecialchars($center['CenterName'], ENT_QUOTES, 'UTF-8'); ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="filterType">Department Type</label>
                        <select class="form-control" id="filterType">
                            <option value="">All Types</option>
                            <?php foreach ($this->departmentTypes as $type): ?>
                            <option value="<?php echo $type['DepartmentTypeID']; ?>">
                                <?php echo htmlspecialchars($type['DepartmentTypeName'], ENT_QUOTES, 'UTF-8'); ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="filterStatus">Status</label>
                        <select class="form-control" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Departments Table Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Departments Management</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addDepartmentModal">
                            <i class="fa fa-plus"></i> Add New Department
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="departmentsTable" class="table table-bordered table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Center</th>
                                    <th>Department Name</th>
                                    <th>Type</th>
                                    <th>Code</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Department</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="addDepartmentFormContainer">
                <!-- Form will be loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Department Modal -->
<div class="modal fade" id="editDepartmentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Department</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="editDepartmentFormContainer">
                <!-- Form will be loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this department?</p>
                <input type="hidden" id="deleteDepartmentId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#departmentsTable').DataTable({
        "processing": true,
        "serverSide": false,
        "ajax": {
            "url": "<?php echo $this->url(array('module' => 'Department', 'controller' => 'department', 'action' => 'index'), 'default', true); ?>",
            "type": "POST"
        },
        "columns": [
            {"data": "DepartmentID", "className": "text-center"},
            {"data": "CenterName"},
            {"data": "DepartmentName"},
            {"data": "DepartmentTypeName", "className": "text-center"},
            {"data": "DepartmentCode", "className": "text-center"},
            {"data": "Phone1", "className": "text-center"},
            {"data": "IsActive", "className": "text-center"},
            {"data": "CreatedAt", "className": "text-center"},
            {"data": "CreatedByName", "className": "text-center"},
            {"data": "Actions", "className": "text-center", "orderable": false}
        ],
        "responsive": true,
        "pageLength": 25,
        "order": [[0, 'desc']],
        "language": {
            "emptyTable": "No departments found",
            "info": "Showing _START_ to _END_ of _TOTAL_ departments",
            "infoEmpty": "Showing 0 to 0 of 0 departments",
            "infoFiltered": "(filtered from _MAX_ total departments)",
            "lengthMenu": "Show _MENU_ departments",
            "loadingRecords": "Loading...",
            "processing": "Processing...",
            "search": "Search:",
            "zeroRecords": "No matching departments found"
        }
    });

    // Apply filters
    $('#filterCenter, #filterType, #filterStatus').on('change', function() {
        var center = $('#filterCenter').val();
        var type = $('#filterType').val();
        var status = $('#filterStatus').val();
        
        table.columns(1).search(center);
        table.columns(3).search(type);
        table.columns(6).search(status);
        table.draw();
    });

    // Load add department form
    $('#addDepartmentModal').on('show.bs.modal', function() {
        $('#addDepartmentFormContainer').load('<?php echo $this->url(array('module' => 'Department', 'controller' => 'department', 'action' => 'add-department'), 'default', true); ?>');
    });

    // Load edit department form
    $(document).on('click', '.edit-department', function() {
        var departmentId = $(this).data('id');
        $('#editDepartmentFormContainer').load('<?php echo $this->url(array('module' => 'Department', 'controller' => 'department', 'action' => 'edit-department'), 'default', true); ?>?id=' + departmentId, function() {
            $('#editDepartmentModal').modal('show');
        });
    });

    // Delete department
    $(document).on('click', '.delete-department', function() {
        var departmentId = $(this).data('id');
        $('#deleteDepartmentId').val(departmentId);
        $('#deleteModal').modal('show');
    });

    // Confirm delete
    $('#confirmDelete').click(function() {
        var departmentId = $('#deleteDepartmentId').val();
        $.ajax({
            url: '<?php echo $this->url(array('module' => 'Department', 'controller' => 'department', 'action' => 'delete'), 'default', true); ?>',
            type: 'POST',
            data: {id: departmentId},
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    $('#deleteModal').modal('hide');
                    table.ajax.reload();
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            }
        });
    });

    // Alert function
    function showAlert(type, message) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="close" data-dismiss="alert">' +
            '<span>&times;</span>' +
            '</button>' +
            '</div>';
        
        $('.container-fluid').prepend(alertHtml);
        
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});
</script>
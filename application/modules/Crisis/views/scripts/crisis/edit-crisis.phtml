<?php 
$crisis = $this->crisis;
$translate = $this->translate;
?>
<form id="editCrisisForm" method="post" action="<?php echo $this->url(array('module' => 'Crisis', 'controller' => 'crisis', 'action' => 'edit-crisis'), null, true); ?>/id/<?php echo $crisis['CrisisID']; ?>">
    <input type="hidden" name="CrisisID" value="<?php echo $crisis['CrisisID']; ?>">
    
    <div class="form-group">
        <label for="CrisisCode"><?php echo $translate->_('Crisis Code'); ?> *</label>
        <input type="text" class="form-control" id="CrisisCode" name="CrisisCode" required 
               value="<?php echo htmlspecialchars($crisis['CrisisCode'], ENT_QUOTES, 'UTF-8'); ?>"
               placeholder="<?php echo $translate->_('e.g., CRS-001'); ?>">
        <small class="form-text text-muted"><?php echo $translate->_('Unique code for the crisis'); ?></small>
    </div>
    
    <div class="form-group">
        <label for="CrisisTitle"><?php echo $translate->_('Crisis Title'); ?> *</label>
        <input type="text" class="form-control" id="CrisisTitle" name="CrisisTitle" required 
               value="<?php echo htmlspecialchars($crisis['CrisisTitle'], ENT_QUOTES, 'UTF-8'); ?>"
               placeholder="<?php echo $translate->_('Enter crisis title'); ?>">
        <small class="form-text text-muted"><?php echo $translate->_('Brief title describing the crisis'); ?></small>
    </div>
    
    <div class="form-group">
        <label for="CrisisTypeID"><?php echo $translate->_('Crisis Type'); ?> *</label>
        <select class="form-control" id="CrisisTypeID" name="CrisisTypeID" required>
            <option value=""><?php echo $translate->_('Select Type'); ?></option>
            <?php foreach ($this->crisisTypes as $type): ?>
            <option value="<?php echo $type['BaseInfoID']; ?>" 
                <?php echo ($type['BaseInfoID'] == $crisis['CrisisTypeID']) ? 'selected' : ''; ?>>
                <?php echo htmlspecialchars($type['Name'], ENT_QUOTES, 'UTF-8'); ?>
            </option>
            <?php endforeach; ?>
        </select>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label><?php echo $translate->_('Status'); ?></label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveYes" value="1" 
                        <?php echo ($crisis['IsActive'] == 1) ? 'checked' : ''; ?>>
                    <label class="form-check-label" for="ActiveYes">
                        <?php echo $translate->_('Active'); ?>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="IsActive" id="ActiveNo" value="0"
                        <?php echo ($crisis['IsActive'] == 0) ? 'checked' : ''; ?>>
                    <label class="form-check-label" for="ActiveNo">
                        <?php echo $translate->_('Inactive'); ?>
                    </label>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label><?php echo $translate->_('Record Information'); ?></label>
                <div class="small text-muted">
                    <div>
                        <i class="fa fa-calendar"></i> 
                        <?php echo $translate->_('Created:'); ?> <?php echo date('Y-m-d H:i', strtotime($crisis['CreatedAt'])); ?>
                    </div>
                    <?php if (!empty($crisis['UpdatedAt'])): ?>
                    <div>
                        <i class="fa fa-edit"></i> 
                        <?php echo $translate->_('Last Updated:'); ?> <?php echo date('Y-m-d H:i', strtotime($crisis['UpdatedAt'])); ?>
                    </div>
                    <?php endif; ?>
                    <?php if (!empty($crisis['CreatedBy'])): ?>
                    <div>
                        <i class="fa fa-user"></i> 
                        <?php echo $translate->_('Created By:'); ?> User #<?php echo $crisis['CreatedBy']; ?>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    
    <hr>
    
    <div class="alert alert-warning">
        <i class="fa fa-exclamation-triangle"></i> 
        <strong><?php echo $translate->_('Note:'); ?></strong> 
        <?php echo $translate->_('Changing the Crisis Code may affect other parts of the system that reference this crisis.'); ?>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fa fa-times"></i> <?php echo $translate->_('Cancel'); ?>
        </button>
        <button type="button" class="btn btn-danger" id="deleteCrisisBtn">
            <i class="fa fa-trash"></i> <?php echo $translate->_('Delete'); ?>
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> <?php echo $translate->_('Update Crisis'); ?>
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    var crisisId = <?php echo $crisis['CrisisID']; ?>;
    var originalCode = '<?php echo $crisis['CrisisCode']; ?>';
    var translate = {
        confirmChange: "<?php echo $translate->_('You are changing the Crisis Code from \"{old}\" to \"{new}\".\\n\\nThis may affect other parts of the system.\\n\\nAre you sure you want to continue?'); ?>",
        requiredCode: "<?php echo $translate->_('Crisis Code is required'); ?>",
        requiredTitle: "<?php echo $translate->_('Crisis Title is required'); ?>",
        requiredType: "<?php echo $translate->_('Please select a crisis type'); ?>",
        deleteConfirm: "<?php echo $translate->_('Are you sure you want to delete this crisis?\\n\\nCrisis Code: {code}\\n\\nThis action cannot be undone!'); ?>"
    };
    
    // Form validation and submission
    $('#editCrisisForm').on('submit', function(e) {
        e.preventDefault();
        
        // Clear previous error states
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Basic validation
        var isValid = true;
        
        if (!$('#CrisisCode').val().trim()) {
            $('#CrisisCode').addClass('is-invalid');
            $('#CrisisCode').after('<div class="invalid-feedback">' + translate.requiredCode + '</div>');
            isValid = false;
        }
        
        if (!$('#CrisisTitle').val().trim()) {
            $('#CrisisTitle').addClass('is-invalid');
            $('#CrisisTitle').after('<div class="invalid-feedback">' + translate.requiredTitle + '</div>');
            isValid = false;
        }
        
        if (!$('#CrisisTypeID').val()) {
            $('#CrisisTypeID').addClass('is-invalid');
            $('#CrisisTypeID').after('<div class="invalid-feedback">' + translate.requiredType + '</div>');
            isValid = false;
        }
        
        if (!isValid) {
            return false;
        }
        
        // Warn if Crisis Code changed
        var newCode = $('#CrisisCode').val();
        if (newCode !== originalCode) {
            var message = translate.confirmChange
                .replace('{old}', originalCode)
                .replace('{new}', newCode);
            
            if (!confirm(message)) {
                return false;
            }
        }
        
        // Show loading state
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> <?php echo $translate->_("Updating..."); ?>');
        
        // Submit form via AJAX
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                try {
					
                    var result = JSON.parse(response);
					console.log(result);
                    if (result.success) {
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: '<?php echo $translate->_("Updated!"); ?>',
                            text: result.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Close modal and reload table
                        setTimeout(function() {
                            $('#editCrisisModal').modal('hide');
                            $('#crisesTable').DataTable().ajax.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        Swal.fire({
                            icon: 'error',
                            title: '<?php echo $translate->_("Error!"); ?>',
                            text: result.message
                        });
                        
                        // Re-enable submit button
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: '<?php echo $translate->_("Error!"); ?>',
                        text: '<?php echo $translate->_("An error occurred while processing the response"); ?>'
                    });
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: '<?php echo $translate->_("Error!"); ?>',
                    text: '<?php echo $translate->_("An error occurred while updating:"); ?> ' + error
                });
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Delete crisis button
    $('#deleteCrisisBtn').on('click', function() {
        var message = translate.deleteConfirm.replace('{code}', originalCode);
        
        Swal.fire({
            icon: 'warning',
            title: '<?php echo $translate->_("Delete Crisis"); ?>',
            text: message,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '<?php echo $translate->_("Yes, delete it!"); ?>',
            cancelButtonText: '<?php echo $translate->_("Cancel"); ?>',
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> <?php echo $translate->_("Deleting..."); ?>');
                
                $.ajax({
                    url: "<?php echo $this->url(array('module' => 'Crisis', 'controller' => 'crisis', 'action' => 'delete'), null, true); ?>",
                    type: "POST",
                    data: {id: crisisId},
                    success: function(response) {
                        var result = JSON.parse(response);
                        if (result.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '<?php echo $translate->_("Deleted!"); ?>',
                                text: result.message,
                                timer: 2000,
                                showConfirmButton: false
                            });
                            
                            setTimeout(function() {
                                $('#editCrisisModal').modal('hide');
                                $('#crisesTable').DataTable().ajax.reload();
                            }, 1500);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '<?php echo $translate->_("Error!"); ?>',
                                text: result.message
                            });
                            $('#deleteCrisisBtn').prop('disabled', false).html('<i class="fa fa-trash"></i> <?php echo $translate->_("Delete"); ?>');
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: '<?php echo $translate->_("Error!"); ?>',
                            text: '<?php echo $translate->_("An error occurred while deleting"); ?>'
                        });
                        $('#deleteCrisisBtn').prop('disabled', false).html('<i class="fa fa-trash"></i> <?php echo $translate->_("Delete"); ?>');
                    }
                });
            }
        });
    });

    // Auto-focus first field when modal opens
    $('#editCrisisModal').on('shown.bs.modal', function() {
        $('#CrisisCode').focus().select();
    });

    // Reset form validation on input
    $('input, select').on('input change', function() {
        $(this).removeClass('is-invalid');
        $(this).next('.invalid-feedback').remove();
    });
});
</script>

<style>
.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 80%;
    color: #dc3545;
}
</style>
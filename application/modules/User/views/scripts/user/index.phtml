<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <h2 class="card-text"><?php echo $this->stats['total'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Active Users</h5>
                    <h2 class="card-text"><?php echo $this->stats['active'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Inactive Users</h5>
                    <h2 class="card-text"><?php echo $this->stats['inactive'] ?? 0; ?></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Today</h5>
                    <h2 class="card-text"><?php echo date('Y-m-d'); ?></h2>
                </div>
            </div>
        </div>
    </div>

    <!-- User Table Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fa fa-users mr-2"></i>User Management</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">
                            <i class="fa fa-plus"></i> Add New User
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="usersTable" class="table table-bordered table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Mobile</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="fa fa-user-plus mr-2"></i>Add New User
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="addUserFormContainer">
                <!-- Form loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="fa fa-user-edit mr-2"></i>Edit User
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="editUserFormContainer">
                <!-- Form loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fa fa-exclamation-triangle mr-2"></i>Confirm Delete
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="lead">Are you sure you want to delete this user?</p>
                <p class="text-muted">This action cannot be undone.</p>
                <input type="hidden" id="deleteUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fa fa-times mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fa fa-trash mr-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#usersTable').DataTable({
        "processing": true,
        "serverSide": false,
        "ajax": {
            "url": "<?php echo $this->url(array('module' => 'user', 'controller' => 'user', 'action' => 'index'), 'default', true); ?>",
            "type": "POST",
            "error": function(xhr, error, thrown) {
                console.error('DataTable error:', error);
                showAlert('error', 'Error loading users data');
            }
        },
        "columns": [
            {"data": "UserID", "className": "text-center"},
            {"data": "Username"},
            {"data": "FullName"},
            {"data": "Email"},
            {"data": "Mobile"},
            {"data": "IsActive", "className": "text-center"},
            {"data": "CreatedAt", "className": "text-center"},
            {"data": "CreatedByName", "className": "text-center"},
            {"data": "Actions", "className": "text-center", "orderable": false}
        ],
        "responsive": true,
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "order": [[0, 'desc']],
        "language": {
            "emptyTable": "No users found",
            "info": "Showing _START_ to _END_ of _TOTAL_ users",
            "infoEmpty": "Showing 0 to 0 of 0 users",
            "infoFiltered": "(filtered from _MAX_ total users)",
            "lengthMenu": "Show _MENU_ users",
            "loadingRecords": "Loading...",
            "processing": "Processing...",
            "search": "Search:",
            "zeroRecords": "No matching users found"
        }
    });

    // Load add user form
    $('#addUserModal').on('show.bs.modal', function() {
        $('#addUserFormContainer').html('<div class="text-center p-5"><i class="fa fa-spinner fa-spin fa-3x"></i></div>');
        $('#addUserFormContainer').load('<?php echo $this->url(array('module' => 'user', 'controller' => 'user', 'action' => 'add-user'), 'default', true); ?>', function() {
            initFormValidation('#addUserForm');
        });
    });

    // Load edit user form
    $(document).on('click', '.edit-user', function() {
        var userId = $(this).data('id');
        $('#editUserFormContainer').html('<div class="text-center p-5"><i class="fa fa-spinner fa-spin fa-3x"></i></div>');
        $('#editUserFormContainer').load('<?php echo $this->url(array('module' => 'user', 'controller' => 'user', 'action' => 'edit-user'), 'default', true); ?>?id=' + userId, function() {
            initFormValidation('#editUserForm');
            $('#editUserModal').modal('show');
        });
    });

    // Submit add user form
    $(document).on('submit', '#addUserForm', function(e) {
        e.preventDefault();
        var form = $(this);
        var submitBtn = form.find('button[type="submit"]');
        
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Adding...');
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    $('#addUserModal').modal('hide');
                    table.ajax.reload(null, false);
                    showAlert('success', result.message);
                    form[0].reset();
                } else {
                    showAlert('error', result.message);
                }
                submitBtn.prop('disabled', false).html('Add User');
            },
            error: function() {
                showAlert('error', 'Network error. Please try again.');
                submitBtn.prop('disabled', false).html('Add User');
            }
        });
    });

    // Submit edit user form
    $(document).on('submit', '#editUserForm', function(e) {
        e.preventDefault();
        var form = $(this);
        var submitBtn = form.find('button[type="submit"]');
        
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Updating...');
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    $('#editUserModal').modal('hide');
                    table.ajax.reload(null, false);
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
                submitBtn.prop('disabled', false).html('Update User');
            },
            error: function() {
                showAlert('error', 'Network error. Please try again.');
                submitBtn.prop('disabled', false).html('Update User');
            }
        });
    });

    // Delete user
    $(document).on('click', '.delete-user', function() {
        var userId = $(this).data('id');
        $('#deleteUserId').val(userId);
        $('#deleteModal').modal('show');
    });

    // Confirm delete
    $('#confirmDelete').click(function() {
        var userId = $('#deleteUserId').val();
        var deleteBtn = $(this);
        
        deleteBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Deleting...');
        
        $.ajax({
            url: '<?php echo $this->url(array('module' => 'user', 'controller' => 'user', 'action' => 'delete'), 'default', true); ?>',
            type: 'POST',
            data: {id: userId},
            success: function(response) {
                var result = JSON.parse(response);
                if (result.success) {
                    $('#deleteModal').modal('hide');
                    table.ajax.reload(null, false);
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
                deleteBtn.prop('disabled', false).html('<i class="fa fa-trash mr-1"></i> Delete');
            },
            error: function() {
                showAlert('error', 'Network error. Please try again.');
                deleteBtn.prop('disabled', false).html('<i class="fa fa-trash mr-1"></i> Delete');
            }
        });
    });

    // Check username availability
    $(document).on('blur', '#Username', function() {
        var username = $(this).val();
        var userId = $(this).data('user-id') || 0;
        
        if (username.length > 2) {
            $.ajax({
                url: '<?php echo $this->url(array('module' => 'user', 'controller' => 'user', 'action' => 'check-username'), 'default', true); ?>',
                type: 'GET',
                data: {username: username, userId: userId},
                success: function(response) {
                    var result = JSON.parse(response);
                    var input = $('#Username');
                    var feedback = input.parent().find('.username-feedback');
                    
                    if (!feedback.length) {
                        feedback = $('<div class="username-feedback mt-1"></div>');
                        input.parent().append(feedback);
                    }
                    
                    if (result.available) {
                        feedback.html('<span class="text-success"><i class="fa fa-check"></i> ' + result.message + '</span>');
                        input.removeClass('is-invalid').addClass('is-valid');
                    } else {
                        feedback.html('<span class="text-danger"><i class="fa fa-times"></i> ' + result.message + '</span>');
                        input.removeClass('is-valid').addClass('is-invalid');
                    }
                }
            });
        }
    });

    // Form validation helper
    function initFormValidation(formSelector) {
        $(formSelector).find('input[required], select[required], textarea[required]').each(function() {
            $(this).on('invalid', function(e) {
                e.preventDefault();
                $(this).addClass('is-invalid');
            }).on('input', function() {
                if ($(this).val().trim() !== '') {
                    $(this).removeClass('is-invalid');
                }
            });
        });
    }

    // Alert function
    function showAlert(type, message) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            '<i class="fa ' + icon + ' mr-2"></i>' + message +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>' +
            '</div>';
        
        // Remove existing alerts
        $('.alert-dismissible').alert('close');
        
        // Add new alert
        $('.container-fluid').prepend(alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(function() {
            $('.alert-dismissible').alert('close');
        }, 5000);
    }
});
</script>
<?php $availablePersonnel = $this->availablePersonnel; ?>
<form id="addUserForm" method="post" action="<?php echo $this->url(array('module' => 'User', 'controller' => 'user', 'action' => 'add-user'), 'default', true); ?>">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="PersonelID">Link to Personnel (Optional)</label>
                <select class="form-control" id="PersonelID" name="PersonelID">
                    <option value="">-- Select Personnel --</option>
                    <?php foreach ($availablePersonnel as $personnel): ?>
                    <option value="<?php echo $personnel['PersonnelID']; ?>" 
                            data-mobile="<?php echo htmlspecialchars($personnel['Mobile1'], ENT_QUOTES, 'UTF-8'); ?>"
                            data-fullname="<?php echo htmlspecialchars($personnel['FirstName'] . ' ' . $personnel['LastName'], ENT_QUOTES, 'UTF-8'); ?>">
                        <?php echo htmlspecialchars($personnel['FirstName'] . ' ' . $personnel['LastName'] . ' (' . $personnel['NationalCode'] . ')', ENT_QUOTES, 'UTF-8'); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <small class="form-text text-muted">Link this user account to a personnel record</small>
                <div class="invalid-feedback" id="personnel-error">
                    Selected personnel already has a user account
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Username">Username *</label>
                <input type="text" class="form-control" id="Username" name="Username" required>
                <div class="invalid-feedback" id="username-error">
                    Username already taken
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Password">Password *</label>
                <input type="password" class="form-control" id="Password" name="Password" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="FullName">Full Name *</label>
                <input type="text" class="form-control" id="FullName" name="FullName" required>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Mobile">Mobile</label>
                <input type="text" class="form-control" id="Mobile" name="Mobile">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Email">Email</label>
                <input type="email" class="form-control" id="Email" name="Email">
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="IsActive" name="IsActive" value="1" checked>
            <label class="custom-control-label" for="IsActive">Active User</label>
        </div>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add User</button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Username availability check
    $('#Username').on('blur', function() {
        var username = $(this).val();
        
        if (username.length > 2) {
            $.ajax({
                url: '<?php echo $this->url(array('module' => 'User', 'controller' => 'user', 'action' => 'check-username'), 'default', true); ?>',
                type: 'GET',
                data: {username: username},
                success: function(response) {
                    var result = JSON.parse(response);
                    var input = $('#Username');
                    
                    if (result.available) {
                        input.removeClass('is-invalid').addClass('is-valid');
                        $('#username-error').text('');
                    } else {
                        input.removeClass('is-valid').addClass('is-invalid');
                        $('#username-error').text(result.message);
                    }
                }
            });
        }
    });
    
    // Personnel selection - auto-fill user info
    $('#PersonelID').on('change', function() {
        var personnelId = $(this).val();
        var selectedOption = $(this).find('option:selected');
        
        if (personnelId) {
            // Check if personnel is already linked
            $.ajax({
                url: '<?php echo $this->url(array('module' => 'User', 'controller' => 'user', 'action' => 'check-personnel'), 'default', true); ?>',
                type: 'GET',
                data: {personnelId: personnelId},
                success: function(response) {
                    var result = JSON.parse(response);
                    var input = $('#PersonelID');
                    
                    if (result.available) {
                        input.removeClass('is-invalid').addClass('is-valid');
                        $('#personnel-error').text('');
                        
                        // Auto-fill user information from personnel
                        var mobile = selectedOption.data('mobile');
                        var fullName = selectedOption.data('fullname');
                        
                        if (mobile && !$('#Mobile').val()) {
                            $('#Mobile').val(mobile);
                        }
                        if (fullName && !$('#FullName').val()) {
                            $('#FullName').val(fullName);
                        }
                    } else {
                        input.removeClass('is-valid').addClass('is-invalid');
                        $('#personnel-error').text(result.message);
                        $(this).val('');
                    }
                }
            });
        } else {
            $('#PersonelID').removeClass('is-valid is-invalid');
            $('#personnel-error').text('');
        }
    });
    
    // Form submission validation
    $('#addUserForm').on('submit', function(e) {
        var isValid = true;
        
        // Validate username
        var username = $('#Username').val().trim();
        if (!username) {
            $('#Username').addClass('is-invalid');
            isValid = false;
        }
        
        // Validate password
        var password = $('#Password').val();
        if (!password) {
            $('#Password').addClass('is-invalid');
            isValid = false;
        }
        
        // Validate full name
        var fullName = $('#FullName').val().trim();
        if (!fullName) {
            $('#FullName').addClass('is-invalid');
            isValid = false;
        }
        
        // Validate personnel (if selected)
        var personnelId = $('#PersonelID').val();
        if (personnelId) {
            // Additional check before submission
            $.ajax({
                url: '<?php echo $this->url(array('module' => 'User', 'controller' => 'user', 'action' => 'check-personnel'), 'default', true); ?>',
                type: 'GET',
                data: {personnelId: personnelId},
                async: false,
                success: function(response) {
                    var result = JSON.parse(response);
                    if (!result.available) {
                        $('#PersonelID').addClass('is-invalid');
                        $('#personnel-error').text(result.message);
                        isValid = false;
                    }
                }
            });
        }
        
        if (!isValid) {
            e.preventDefault();
            alert('Please correct the errors in the form');
            return false;
        }
        
        return true;
    });
    
    // Clear validation on focus
    $('input, select').on('focus', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>